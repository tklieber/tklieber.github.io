Table des matières :

[SSRF - Introduction](#SSRF - Introduction)

[Qu'est-ce qu'une SSRF ?](#Qu'est-ce qu'une SSRF ?)

[Les impacts d'une SSRF](#Les impacts d'une SSRF)

[SSRF vs CSRF vs XSS](#SSRF vs CSRF vs XSS)

[Les types de SSRF](#Les Type d'SSRF)

blind et regular

    [Exploitation local](#Exploitation local) => schéma de fonctionnement

        physique et cloud

    [Exploitation d'un serveur distant](#Exploitation d'un serveur disant) => schéma de fonctionnement

    [Scan réseau](#Scan réseau) => schéma de fonctionnement

    [DDOS](#DDOS)

[Les mechanismes de protection et leur contournements](#Les mechanismes de protection et leur contournements)

     WL / BL des fluxs de l'appli web (dns rebinding ; dns subdomain w/ good domain and parent domain the evil one)

[Conclusion](#Conclusion)

<mark>BurpSuit est recommendé pour cette partie</mark>

# SSRF - Introduction

Souvent nous pensons que pour nous protéger des accès illégitimes au réseau interne de notre entreprise, il nous suffit d'avoir une politique très restrictive sur notre firewall ou qu'il faut que l'attaquant ai accès à une machine compromise. Or cela n'est pas troujours vrai. En effet avec la vulnérabilité web que nous allons présenter dans ce chapitre, nous allons voire que même si nous avons mis la politique de filtrage firewall la plus restructive ou qu'aucune machine de notre front-end est compromise, nous pouvons tout de même accéder au réseau interne et à des informations précieuses de notre système d'information. 

Dans ce chapitre nous allons aborder une vulnérabilité web, côté serveur, qui est présente dans le top 10 OWASP de 2021 et le Top 25 CWE™ (Common Weakness Enumeration) de 2021 : les **Server-Side Request Forgery (SSRF)**.

Les SSRF sont pas de toute nouvelles vulnérabilités. En effet, les premières exploitation de cette vulnérabilités sont apparue en 2008. Par contre c'est uniquement en 2013 qu'elles SSRF sont apparues pour la première fois dans le CWE™ (Common Weakness Enumeration) mais n'étaient pas encore dans le top 25. 

Pour donner un exemple concrait, une des exploitation SSRF les plus célèbre et le piratage de l'entreprise Capital One en juillet 2019. Malgrès leur WAF (Web Application Firewall) qui protégeais l'infrastructure, l'attaquant à pu accéder à toute l'infrastructure de l'entreprise. Cela à mené au vole de plus de 100 millions de données Dans ce piratage, l'attaquant a pu voler les données privées de plus de 100 millions d'utilisateurs.

`Dans un premier temps nous allons expliquer ce qu'est une SSRF. Ensuite nous allons comparer cette vulnérabilité avec d'autres vulnérabilités similaires et pour finir nous démontreront comment trouver et exploiter cette faille`

# Qu'est-ce qu'une SSRF ?

Les vulnérabilités de type **Server-Side Request Forgery** (traduit littéralement *"falsification de requête côté serveur"*) sont des vulnérabilités qui sont actives côté serveur contrairement à des vulnérabilités de type XSS ou CSRF où c'est côté client que la charge active (payload) agit. Bien que cela doit obligatoirement être dû à une action de notre part, nous distinguons tout de même les attaques côté client et serveur (cf chapitre *III. 4. b.*). Nous rentrerons plus en profondeur dans la comparaison entre les SSRF et les XSS et CSRF dans la quatrième partie de ce chapitre.

Une SSRF permet d'interagir avec un serveur hébergeant une application web qui accéde à une ressource distante. Les SSRF sont présentent sur des applications qui ont la nécessité d'interagir avec du contenu externe tel que des API ou des serveurs contenant des images. Les SSRF permettent à l'attaquant d'obliger le serveur applicatif  à envoyer une requête forgé par l'attaquant vers une destination qui est initialement imprévu. Même si le serveur est protéger par un Firewall ou autre type de moyen de restriction d'accès, nous pouvons passer outre grâce à cette vulnérabilité.

Par exemple, un site d'e-commerce qui affiche le stock d'un produit pourrait passer par une API REST pour contacter un serveur externe et avoir les données voulus. Une API REST (Representational state transfer) est une API qui utilise le protocol et les méthodes HTTP pour interagir avec un service. Dans le cadre d'une opération de Redteam nous pouvons donc tenter d'exploiter cette API en changeant l'hôte cible de la requête par exemple.

# Les impacts d'une SSRF

Une attaque SSRF à des impacts fort. Comme nous l'avons cité dans l'introduction de ce chapitre, cette attaque peut mener à l'extraction de données interne à l'entreprise. Cela peut fortemenent nuire à l'image de l'entreprise et avoir des concéquences irréversible sur son image.

Quatre type de conséquence peuvent découdre d'une attaque SSRF. La première est l'analyse de ports sur les serveurs interne à l'entrerprise. Si une mauvaise segmentation réseau est en place alors l'attaquant pourrait faire une cartographie du réseau interne de l'entreprise et déterminer les ports ouverts des machines du réseau interne.

Dans un second temps l'attaquant pourrait collecter des données sensibles, comme ça a été le cas pour l'entreprise Capital One que l'on a cité auparavant. 

Ensuite, pour les infrastructures cloud, les métadonnées des serveurs peuvent fuité. Une vulnérabilités connu est l'accès à l'adresse `http://169.254.169.254/` pour les serveurs Amazon Web Services. Avec ces métadonnées, l'attaquant peut avoir accès à des données sensibles qui pourrait fortement nuire à l'intégrité du Système d'Information.

Pour finir, un attaquant pourrait abuser des services internes à la machine et au parc informatique et aboutir à une RCE (Remote code Execution = *Execution de code à distance*) ou à un DOS (Denial of Service = *Dénie de service*).

# SSRF vs CSRF vs XSS

Pour les néophyte à la cybersécurité la différence entre SSRF, CSRF et XSS est souvent flou. Dans cette partie nous développons plus en détail la différence entre ces trois attaques.

Dans un premier temps nous pouvons distinguer les attaques côté serveur et les attaques côté client. Les attaques côté client exploitent les failles des applications web pour impacter les utilisateurs. A contrario, les attaques côté serveur vont interagir avec le serveur pour exploiter des vulnérabilités ou des erreurs de configuration afin d'extraire des données ou avoir une RCE (Remote Command Execution = *Execution de commandes à distance*). Les attaques de type **SSRF** *sont des attaques de type serveur à l'invers des attaques de type **XSS** et **CSRF**.

Les CSRF permettent de tromper l'état d'une application ou d'une variable sur un site donc par concéquent l'utilisateur du site également. Par exemple l'email sur un site, ce qui impact l'utilisateur voulant utiliser cet email. Les XSS permettent à un attaquant d'injecter dans un site web un code client malveillant. Les SSRF, elles, font faire interagir le serveur ou l'application avec d'autres éléments.

Nous pouvons résumer les différences de la sorte :

| type d'attaque | cible   | action de l'attaque                                   |
| -------------- | ------- | ----------------------------------------------------- |
| SSRF           | Serveur | Abus de fonctionnalités                               |
| CSRF           | Client  | Trompe un utilisateur en changeant un élément du site |
| XSS            | Client  | Injection de script malveillant                       |

# Les types de SSRF

## Deux famille de SSRF

Il existe deux famille d'attaques SSRF : **regular (In Band)** et **blind (Out-of-Band)**. Leur différence est qu'une attaque renvoie des éléments tandis que la second ne renvoie pas de réponse.

Les attaques SSRF regular sont plus facile à exploiter du fait que l'attaquant peut se baser sur la réponse du serveur pour l'éguiller. Les réponses possible sont nombreuses, nous donnerons des exemples concrès à la prochaine section. 

Les blind SSRF sont plus difficile à exploiter car nous travaillons avec peu ou pas du tout de réponse de la part du serveur. Lorsqu'un attaquant souhaite par exemple accéder à la page d'admin d'un site web, vu que le serveur n'emet pas de réponse évidente, l'attaquant à l'obligation de forcer le serveur à faire une résolution DNS afin de prouver la redirection en cours. Nous traiterons plutard les Blind SSRF avec des exemple concrait.

## Les types d'SSRF

Dans cette section nous traiterons les grands type de SSRF existant de nos jours. Nous verrons leur principe de fonctionnement, comment les détecter et comment les exploiter.

### Page d'administration

L'attaque la plus connu est l'accès à des pages illégitime sur l'application web. Le fonctionnement normal d'une application web vulnérable serait la suivante :

Une requête sur un site de vente en ligne par exemple serait schématisé de la sorte. Dans un premier temps l'utilisateur envoie une requête au serveur web (point 1.). Le serveur demande ensuite le contenu demandé via une API à un second site ou une application externe (point 2.). L'API renvoie alors les informations demandés par le serveurs, c'est à dire les prosuits demandés par le client (point 3.). Pour finir, le serveur Web envoie les résultats de la requête faite par le client (point 4.). L'utilisateur à ensuite les données qui sont affichées sur sa page web ou l'application.

![SSRF-Fonctionnement_classique.png](/home/tristan/Documents/Cours/ESGI/FYC/Github/tklieber.github.io/Images/SSRF-Fonctionnement_classique.png)

**/!\ A CHANGER**

Nous pouvons donc aisément imaginer comment nious pouvons détrouner ce méchanisme pour obtenir des informations vérolés.

Dans un permier temps la requête émise par l'utilisateur peut-être changé afin que le serveur recherche des informations que nous avons pas accès en tant qu'utilisateur. Nous pouvons par exemple le requêter lui-même afin de voire s'il n'y a pas de service potentiellement vulnérable pour la suite de notre mission de Red Team. Sinon nous pouvons également essayer d'accéder à des pages Web d'administration. Par exemple `http://localhost/admin`. Cela nous permettrait de monter en privilèges sur l'application web.

Nous pouvons schématiser cela de la sorte :

![SSRF-Fonctionnement.png](/home/tristan/Documents/Cours/ESGI/FYC/Github/tklieber.github.io/Images/SSRF-Fonctionnement.png)

**/!\ A CHANGER**

### Scan réseau

Avec une attaque SSRF nous avons la possibilité de scanner le réseau interne d'un Système d'information ou les ports de la machine elle-même. 

![SSRF-Fonctionnement-port_scan.png](/home/tristan/Documents/Cours/ESGI/FYC/Github/tklieber.github.io/Images/SSRF-Fonctionnement-port_scan.png)    





**les types de SSRF connus**

**    scan réseau**

**    appli web et cloud**

**    accès à des fcontionnalités d'admin**

**    DDOS** (cf [A10 Falsification de requête côté serveur (SSRF) - OWASP Top 10:2021](https://owasp.org/Top10/fr/A10_2021-Server-Side_Request_Forgery_%28SSRF%29/))

# Place à la pratique

## Les mechanismes de protection et leur contournements

Avec deux grosses familles :

- regular / inband

- blind / Out-Of-Band

- 

4 types d'attaques :

**

- Cloud

- Scan réseau

- accès a des fonctionnalités d'admin

### Fonctionnement

Nous pouvons schématiser une application Web avec un fonctionnement normal comme cela :











*source : [From SSRF to Port Scanner | Cobalt](https://www.cobalt.io/blog/from-ssrf-to-port-scanner)*

*source :*

[Understanding the Vulnerability Server-Side Request Forgery](https://www.vaadata.com/blog/understanding-web-vulnerability-server-side-request-forgery-1/)

[From SSRF to Port Scanner | Cobalt](https://www.cobalt.io/blog/from-ssrf-to-port-scanner)

https://www.softwaresecured.com/introduction-to-server-side-request-forgery/

[What is SSRF (Server-side request forgery)? Tutorial &amp; Examples | Web Security Academy](https://portswigger.net/web-security/ssrf)

https://www.skillsoft.com/course/owasp-top-10-a102021-server-side-request-forgery-ssrf-0f911101-8a25-4937-a380-5f3bd806688a

[Server-Side Request Forgery (SSRF) | Complete Guide - YouTube](https://www.youtube.com/watch?v=ih5R_c16bKc)

[SSRF – an old friend in the limelight &gt; Cydrill Software Security](https://cydrill.com/owasp/ssrf-an-old-friend-in-the-limelight/)
