# SSRF - Introduction

Dans ce chapitre nous allons aborder une vulnérabilité web, côté serveur, qui est présente dans le top 10 OWASP de 2021 et le Top 25 CWE™ (Common Weakness Enumeration) de 2021 : les **Server-Side Request Forgery (SSRF)**.

Dans un premier temps nous développerons ce qu'est une SSRF, ensuite nous verrons les impacts de cette vulnérabilité et nous finirons avec les types de SSRF connu est des démonstrations de fonctionnement. 

# Définition d'une SSRF

Les vulnérabilités de type **Server-Side Request Forgery** (traduit littéralement *"falsification de requête côté serveur"*) sont des vulnérabilités qui sont actives côté serveur contrairement à des vulnérabilités de type XSS ou CSRF où c'est côté client que la charge active (payload) agit. Bien que cela doit obligatoirement être dû à une action de notre part, nous distinguons tout de même les attaques côté client et serveur (cf chapitre *III. 4. b.*). Nous rentrerons plus en profondeur dans la comparaison entre les SSRF et les XSS et CSRF dans la quatrième partie de ce chapitre.

Une SSRF permet d'interagir avec un serveur hébergeant une application web qui accéde à une ressource distante. Les SSRF sont présentent sur des applications qui ont la nécessité d'interagir avec du contenu externe tel que des API ou des serveurs contenant des images. Les SSRF permettent à l'attaquant d'obliger le serveur applicatif  à envoyer une requête forgé par l'attaquant vers une destination qui est initialement imprévu. Même si le serveur est protéger par un Firewall ou autre moyen de restriction d'accès, nous pouvons passer outre grâce à cette vulnérabilité.

Comme exemple concret nous avons un site d'e-commerce qui affiche le stock d'un produit. La requête pour déterminer le stock pourrait passer par une API REST pour contacter un serveur externe et avoir les données voulus. Une API REST (Representational state transfer) est une API qui utilise le protocol et les méthodes HTTP pour interagir avec un service. Dans le cadre d'une opération de Redteam nous pouvons donc tenter d'exploiter cette API en changeant l'hôte cible de la requête par exemple.

# Les impacts d'une SSRF

Une attaque SSRF à des impacts fort. Quatre types d'impact peuvent découdre d'une attaque SSRF. La première est l'analyse de ports sur les serveurs interne à l'entrerprise. Si une mauvaise segmentation réseau est en place alors l'attaquant pourrait faire une cartographie du réseau interne de l'entreprise et déterminer les ports ouverts des machines du réseau interne.

Ensuite l'attaquant pourrait extraire des données sensibles ou des métadonnées. Pour finir, un attaquant pourrait abuser des services internes à la machine ou au parc informatique et aboutir à une RCE (Remote code Execution = *Execution de code à distance*) ou à un DOS (Denial of Service = *Dénie de service*).

# Les types de SSRF

Dans cette section nous traiterons les grands type de SSRF existant de nos jours. Nous verrons leur principe de fonctionnement, comment les détecter et comment les exploiter.

### Page d'administration

L'attaque la plus connu est l'accès à des pages illégitime sur l'application web. Le fonctionnement normal d'une application web vulnérable serait la suivante :

Une requête pour déterminer la loste des procuits en stock sur un site de vente en ligne serait schématisé de la sorte. Dans un premier temps l'utilisateur envoie une requête au serveur web (point 1.). Le serveur demande ensuite le contenu demandé via une API à un second site ou une application externe (point 2.). L'API renvoie alors les informations demandés par le serveurs, c'est à dire les prosuits demandés par le client (point 3.). Pour finir, le serveur Web envoie les résultats de la requête faite par le client (point 4.). L'utilisateur à ensuite les données qui sont affichées sur sa page web ou l'application.

<img src="file:///home/tristan/Documents/Cours/ESGI/FYC/Github/tklieber.github.io/Images/SSRF-Fonctionnement_pageWeb.png" title="" alt="" width="511">

Nous pouvons donc aisément imaginer comment nious pouvons détrouner ce méchanisme pour obtenir des informations vérolés.

Dans un permier temps la requête émise par l'utilisateur peut-être changé afin que le serveur recherche des informations que nous avons pas accès en tant qu'utilisateur. Nous pouvons par exemple le requêter lui-même afin de voire s'il n'y a pas de service potentiellement vulnérable pour la suite de notre mission de Red Team. Sinon nous pouvons également essayer d'accéder à des pages Web d'administration. Par exemple `http://localhost/admin`. Cela nous permettrait de monter en privilèges sur l'application web.

Nous pouvons schématiser cela de la sorte :

<img title="" src="file:///home/tristan/Documents/Cours/ESGI/FYC/Github/tklieber.github.io/Images/SSRF-Fonctionnement_admin.png" alt="SSRF-Fonctionnement_classique2.png" width="448">

### Scan réseau

Avec une attaque SSRF nous avons la possibilité de scanner le réseau interne d'un Système d'information ou les ports de la machine elle-même. Tout comme l'attaque précédente il suffit de changer l'adresse qui sera utilisé par l'API pour, par exemple, chercher si un port est ouvert sur la machine de l'appli web.

L'image ci-dessous illustre bien cette vulnérabilité avec notamment le retour d'erreur observer. En effet la banière SSH est affiché lors de la tentative d'accès au port 22 de l'hôte de la page web. 

<img src="file:///home/tristan/Documents/Cours/ESGI/FYC/Github/tklieber.github.io/Images/SSRF-Fonctionnement-port_scan.png" title="" alt="SSRF-Fonctionnement-port_scan.png" width="538"> 

*source : [From SSRF to Port Scanner | Cobalt](https://www.cobalt.io/blog/from-ssrf-to-port-scanner)*

Extraction de métadonnées :

dans cette partie nous pouvons constater que le retour d'erreur est crutial dans l'exploitation de cette vulnérabilité. En effet sans retour d'erreur il nous ai très compliqué voir impossible à exploiter cette faille à l'inverse de nombreuses vulnérabilités web comme les injections SQL par exemple.

### appli web et cloud

Un autre type de SSRF serait l'extraction de données confidentiels vis à vis du cloud AWS.

Dans l'exemple ci-dessous nous exploitons la vulnérabilité la plus connu qui consiste à faire requêter l'appli web hébergé sur AWS sur sa propre adresse de métadonées. En l'occurence `169.254.169.254`.

<img src="file:///home/tristan/Documents/Cours/ESGI/FYC/Github/tklieber.github.io/Images/SSRF-AWS.png" title="" alt="SSRF-AWS.png" width="529">

Nous avons réussit à extraire le nom du rôle utilisé pour la page web : `tf-kungfu-role`. Après nous pouvons extraire ça clé privé AWS et un token de connexion. Ces éléments peuvent être réutilisé pour extraire différentes donneés de l'instance AWS. Par exemple l'entreprise Capital One à eu plus de 100 millions de données clients qui ont été extraite grâce à cette vulnérabilité.

<img title="" src="file:///home/tristan/Documents/Cours/ESGI/FYC/Github/tklieber.github.io/Images/SSRF-AWS2.png" alt="SSRF-AWS2.png" width="654">

[Understanding the Vulnerability Server-Side Request Forgery](https://www.vaadata.com/blog/understanding-web-vulnerability-server-side-request-forgery-1/)

[From SSRF to Port Scanner | Cobalt](https://www.cobalt.io/blog/from-ssrf-to-port-scanner)

https://www.softwaresecured.com/introduction-to-server-side-request-forgery/

[What is SSRF (Server-side request forgery)? Tutorial &amp; Examples | Web Security Academy](https://portswigger.net/web-security/ssrf)

https://www.skillsoft.com/course/owasp-top-10-a102021-server-side-request-forgery-ssrf-0f911101-8a25-4937-a380-5f3bd806688a

[Server-Side Request Forgery (SSRF) | Complete Guide - YouTube](https://www.youtube.com/watch?v=ih5R_c16bKc)

[SSRF – an old friend in the limelight &gt; Cydrill Software Security](https://cydrill.com/owasp/ssrf-an-old-friend-in-the-limelight/)
